---
title: Using Terraform templates
sidebar_position: 4
---

import TierLabel from "../_components/TierLabel";

# Using Terraform templates <TierLabel tiers="enterprise" />

This guide will show you how to use a template to create a Terraform resource in Weave GitOps Enterprise.

### Pre-requisites
- Install [Weave GitOps Enterprise](installation.mdx#weave-gitops-enterprise) with [TF-Controller installed](installation.mdx#tf-controller) and [TLS enabled](../configuration/tls.md).

### 1. Add a template to your cluster 

Add a Terraform `GitOpsTemplate` manifest, such as the one below, to your config repository at `./clusters/<cluster-name>/tf-template.yaml` or any path that Flux is configured to watch. Commit and push these changes. Once a template is available in the cluster, it can be used to create a Terraform resource, which will be shown in the next step.

```yaml title="./clusters/my-cluster/tf-template.yaml"
---
apiVersion: clustertemplates.weave.works/v1alpha1
kind: GitOpsTemplate
metadata:
  name: tf-template
  namespace: default
spec:
  description: 
    This is a sample WGE template that will be translated into a tf-controller specific template.
  params:
    - name: RESOURCE_NAME
      description: Resource Name
  resourcetemplates:
    - apiVersion: infra.contrib.fluxcd.io/v1alpha1
      kind: Terraform
      metadata:
        name: ${RESOURCE_NAME}
        namespace: flux-system
      spec:
        interval: 1h
        path: ./
        approvePlan: "auto"
        sourceRef:
          kind: GitRepository
          name: flux-system
          namespace: flux-system
```

You can verify that your template is in your cluster by running:
```bash
kubectl get gitopstemplates.clustertemplates.weave.works -A
NAME                                AGE
sample-wge-tf-controller-template   14m
```

If the template does not appear immediately, you can force Flux to reconcile the changes:
```bash
flux reconcile kustomization flux-system
► annotating Kustomization flux-system in flux-system namespace
✔ Kustomization annotated
◎ waiting for Kustomization reconciliation
✔ applied revision main/e6f5f0c3925bcfecdb50bceb12af9a87677d2213
```

### 2. Create a Terraform resource
A Terraform resource can be created from a template by specifying the template's name and supplying values to it, as well as your Weave GitOps Enterprise username, password, and HTTP API endpoint.
```bash
gitops add terraform --from-template sample-wge-tf-controller-template --set="RESOURCE_NAME"="name" --username=<username> --password=<password> --endpoint https://localhost:8000 --url <config-repo>
```

This will create a PR in your config repository with the manifest of the Terraform resource. Once the PR is merged, TF-Controller will apply the Terraform manifest, create the resources, and reconcile any changes that you make to the Terraform manifest in your config repo! 

### 3. List available templates
Get a specific template that can be used to create a Terraform resource:
```bash
gitops get template terraform sample-wge-tf-controller-template --endpoint https://localhost:8000 --username=<username> --password=<password>
NAME                                PROVIDER   DESCRIPTION                                                                                     ERROR
sample-wge-tf-controller-template              This is a sample WGE template that will be translated into a tf-controller specific template.
```

List all the templates available on the cluster:
```bash
gitops get template terraform --endpoint https://localhost:8000 --username=<username> --password=<password>
NAME                                PROVIDER   DESCRIPTION                                                                                     ERROR
sample-aurora-tf-template                      This is a sample Aurora RDS template.
sample-wge-tf-controller-template              This is a sample WGE template that will be translated into a tf-controller specific template.
```

### 4. List the parameters of a template
List all the parameters that can be defined on a specific template:
```bash
gitops get template terraform tf-controller-aurora --list-parameters --endpoint https://localhost:8000 --username=<username> --password=<password>
NAME            REQUIRED   DESCRIPTION     OPTIONS
RESOURCE_NAME   false      Resource Name
```

## Use Case: Aurora RDS  
:::tip BONUS

Ready for a more advanced example? Here is a template to create an Aurora DB using WGE and the TF-Controller. 
:::

### Pre-requisites
- Everything from the [previous section](#pre-requisites)
- Set credentials with the Terraform AWS Provider

### 2. Add a template to your cluster

In the yaml file below, at `spec.resourcetemplates.path`, `./rds.tf` is a Terraform manifest that can be found [here](TODO: where should I add the example? Is there an [examples](https://www.github.com/weaveworks/eksctl/tree/main/examples/) dir in the `weave-gitops` repo?).

This Terraform manifest will create an S3 bucket and an [Aurora DB](https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Overview.html).

```title=“./clusters/<name-of-cluster>/sample-tf-template-2.yaml”
---
apiVersion: clustertemplates.weave.works/v1alpha1
kind: GitOpsTemplate
metadata:
  name: sample-aurora-tf-template
  namespace: default
spec:
  description: This is a sample Aurora RDS template.
  params:
    - name: RESOURCE_NAME
      description: Resource Name
    - name: CLUSTER_IDENTIFIER
      description: Cluster Identifier
    - name: DATABASE_BASE
      description: Database Base
    - name: BACKUP_RETENTION_PERIOD
      description: Backup Retention Period
    - name: REGION
      description: Region
    - name: S3_IMPORT_BUCKET
      description: S3 Import Bucket
    - name: MAIN_USERNAME
      description: Main Username
    - name: MAIN_PASSWORD
      description: Main Password
  resourcetemplates:
    - apiVersion: infra.contrib.fluxcd.io/v1alpha1
      kind: Terraform
      metadata:
        name: ${RESOURCE_NAME}
        namespace: flux-system
      spec:
        interval: 1h // Set the interval at which Flux will fetch the Git source and reconcile changes
        path: ./_artifacts/rds
        approvePlan: “auto” // See TF-Controller docs on [“The manual mode: plan and manual apply”](https://weaveworks.github.io/tf-controller/use_cases/#the-manual-mode-plan-and-manual-apply)
        vars:
        - name: cluster_identifier
          value: ${CLUSTER_IDENTIFIER}
        - name: database_name
          value: ${DATABASE_NAME}
        - name: backup_retention_period
          value: ${BACKUP_RETENTION_PERIOD}
        - name: region
          value: ${REGION}
        - name: s3_import_bucket
          value: ${S3_IMPORT_BUCKET}
        - main_username
          value: ${MAIN_USERNAME}
        - main_password
          value: ${MAIN_PASSWORD}
        sourceRef: // This is the Git source. It is configured to reconcile your config repo.
          kind: GitRepository
          name: flux-system
          namespace: flux-system
```

### 3. Create the TF resource
```bash
gitops add terraform --from-template sample-aurora-tf-template \
--username=<username> --password=<password> \
--endpoint https://localhost:8000 \
--url <config-repo> \
--set “RESOURCE_NAME”=“tf-controller-aurora”,“CLUSTER_IDENTIFIER”=“super-awesome-aurora”,“DATABASE_BASE”=“super-awesome-db-name”,“BACKUP_RETENTION_PERIOD”=5,“REGION”=“us-west-2",“S3_IMPORT_BUCKET”=“my-super-amazing-aurora-instance-import-bucket-777" 
```

TODO: Is there an alternative for how to pass values to `--set`? A `-f values.yaml` would be nice, but  yet another `.yaml` file. Multi-line comma-separate map of strings? 
