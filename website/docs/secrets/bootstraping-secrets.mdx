---
title: Bootstrapping Secrets
hide_title: true
---
import AlphaWarning from "../_components/_alpha_warning.mdx";

# Overview

When accessing to protected resources there is a need for a client to authenticate before
the access is granted and the resource is consumed. For the authentication, a client presents
credentials that are either created manually or available through infrastructure a common scenario
is a secrets store.

Weave gitops allows you to provision the secret management infrastructure as part of [its capabilities](./setup-secrets-operator.mdx).
However, in order to provision the secret infrastructure, as any other application that has secrets, we
need to make the secret it needs to install it.

This type of initial secret is what we call it bootstrapping secret and this guide gives you
with the different alternatives that weave gitops gives you to achieve the task.

Bootstrapping secrets will be not only present while provision your secrets managmenet solution but in
any platform provisioning task that comes before you have avaialble before the secrets management solution
is availabe. Another common example is provisioning platform capabilities itself via
https://docs.gitops.weave.works/docs/cluster-management/getting-started/#profiles-and-clusters
that are stored in private repositories. For example https://fluxcd.io/flux/guides/helmreleases/#helm-repository-authentication-with-credentials

To address this problem, weave gitops provides the following alternatives:

- SecretSync CRD: to leverage weave gitops for secrets bootstrapping.

## Using `SecretSync` Custom Resource

<AlphaWarning/>

`SecretSync` is a [Kubernetes Customer Resource](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/)
that provides semantics to sync [Kuberentes Secrets](https://kubernetes.io/docs/concepts/configuration/secret/) from management cluster to leaf clusters.

An example could be seen below:

```yaml
apiVersion: capi.weave.works/v1alpha1
kind: SecretSync
metadata:
  name: my-dev-secret-syncer
  namespace: default
spec:
  clusterSelector:
    matchLabels:
      environment: dev
  secretRef:
    name: my-dev-secret
  targetNamespace: my-namespace
```
Where you could find two main configuration sections:

1) Select the secret to sync:

```yaml
  secretRef:
    name: my-dev-secret
```

2) Select the [GitopsClusters](https://docs.gitops.weave.works/docs/cluster-management/managing-existing-clusters/)
,that the secret will be synced to, via labels:

```yaml
  clusterSelector:
    matchLabels:
      environment: dev
```

More info about the CRD spec [here](./spec/v1alpha1/secretSync.mdx)

### Working with SecretSync

#### Before start

1. You are using [Weave Gitops Enterprise version > v0.19.0](https://docs.gitops.weave.works/docs/releases/#v0190)
2. You are running cluster-bootstrap-controller > v0.5.0
2. You have a secret that you want to sync from the management cluster.
3. You have a set of GitopsClusters that you want to sync to.

#### Syncing secrets via SecretSync

1. Create SecretSync manifests using the secret for example

```yaml
apiVersion: capi.weave.works/v1alpha1
kind: SecretSync
metadata:
  name: my-dev-secret-syncer
  namespace: default
spec:
  clusterSelector:
    matchLabels:
      environment: dev
  secretRef:
    name: my-dev-secret
  targetNamespace: my-namespace
```

2. Check-in to your configuration repo within your management cluster

3. Create a PR, review and merge

4. See the progress

```bash
kubectl get secretsyncs.capi.weave.works my-dev-secret-syncer -o yaml

apiVersion: capi.weave.works/v1alpha1
kind: SecretSync
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"capi.weave.works/v1alpha1","kind":"SecretSync","metadata":{"annotations":{},"name":"my-dev-secret-syncer","namespace":"default"},"spec":{"clusterSelector":{"matchLabels":{"environment":"dev"}},"secretRef":{"name":"my-dev-secret"},"targetNamespace":"my-namespace"}}
  creationTimestamp: "2023-03-28T16:44:37Z"
  generation: 1
  name: my-dev-secret-syncer
  namespace: default
  resourceVersion: "4980"
  uid: f6670578-4403-46f8-a9b5-de8c80559c2b
spec:
  clusterSelector:
    matchLabels:
      environment: dev
  secretRef:
    name: my-dev-secret
  targetNamespace: my-namespace
```

that once reconciled, the status section would show created secret resource version

```
status:
  versions:
    leaf-cluster-1: "211496"
```

5. See the secret created in your leaf cluster

Your secret has been created in the target leaf cluster

```bash
âžœ  kubectl get secret -n default
NAME               TYPE                                  DATA   AGE
my-dev-secret      Opaque                                1      5h5m
```
