---
title: Setup Sops
hide_title: true
---


# Managing secrets with Sops

Mozilla SOPS is an open source tool for managing secrets. It uses a client-server approach to encrypting and decrypting the data key.

In order to store secrets safely in a public or private Git repository, Flux's kustomize controller integrates with SOPS and the controller will decrypt SOPS-protected secrets during reconciliation.

## Encrypting secrets using OpenPGP

1- Generate a gpg key pairs

```bash
export KEY_NAME="gpg-key"
export KEY_COMMENT="gpg key"

gpg --batch --full-generate-key <<EOF
%no-protection
Key-Type: 1
Key-Length: 4096
Subkey-Type: 1
Subkey-Length: 4096
Expire-Date: 0
Name-Comment: ${KEY_COMMENT}
Name-Real: ${KEY_NAME}
EOF
```

2- export the key pairs fingerprint in the shell
```bash
export KEY_FP="<key pairs fingerprint>"
```

3- Export the generated private key to a kubernetes secret `sops-gpg-private-key`.

```bash
gpg --export-secret-keys --armor "${KEY_FP}" | kubectl create secret generic sops-gpg-private-key --namespace=flux-system --from-file=sops.asc=/dev/stdin
```

4- Export the generated public key to a kubernetes secret `sops-gpg-public-key`.

```bash
gpg --export --armor "${KEY_FP}" | kubectl create secret generic sops-gpg-public-key --namespace=flux-system --from-file=sops.asc=/dev/stdin
```

> It's recommended to remove the secret from your machine

```bash
gpg --delete-secret-keys "${KEY_FP}"
```


5- Configure the `decryption` part in the kustomization object with the private key created in step 3 and reference the public key created in step 4 in the annotations `sops-public-key/name` and `sops-public-key/namespace`.

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: secrets
  namespace: flux-system
  annotations:
    sops-public-key/name: sops-gpg-public-key
    sops-public-key/namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./secrets
  decryption:
    provider: sops
    secretRef:
      name: sops-gpg-private-key
  prune: true
  validation: server -->
```

## Encrypting secrets using Age


1- Generate an age key with age-keygen

```bash
age-keygen -o age.agekey
```

2- Export the generated key to a kubernetes secret `sops-age-private-key`.

```bash
cat age.agekey | kubectl create secret generic sops-age-private-key --namespace=flux-system --from-file=age.agekey=/dev/stdin
```

3- Export the public key of the generated key to a kubernetes secret `sops-age-public-key`.

```bash
echo "<public key>" | kubectl create secret generic sops-age-public-key --namespace=flux-system --from-file=age.agekey=/dev/stdin
```

4- Configure the `decryption` part in the kustomization object with the private key created in step 2 and reference the public key created in step 3 in the annotations `sops-public-key/name` and `sops-public-key/namespace`.

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: secrets
  namespace: flux-system
  annotations:
    sops-public-key/name: sops-age-public-key
    sops-public-key/namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
  path: ./secrets
  decryption:
    provider: sops
    secretRef:
      name: sops-age-private-key
  prune: true
  validation: server
```