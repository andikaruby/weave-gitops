---
title: Managing secrets with Sops
hide_title: true
---

# Managing secrets with Sops

Weave GitOps Enterprise now supports managing secrets using [SOPS](https://github.com/mozilla/sops), a tool that encrypts and decrypts secrets using various key management services.

In this document, we will cover the prerequisites for using SOPS with Weave GitOps Enterprise, and how to configure SOPS for your existing kubernetes cluster to work with GPG and age keys.


## Encrypting secrets using OpenPGP

OpenPGP is a way of using Sops to encrypt and decrypt secrets with Weave GitOps Enterprise.

Here are the steps to generate an OpenPGP key and configure your cluster to work with Weave GitOps Enterprise secrets management.

1- Generate a gpg key pairs

```bash
export KEY_NAME="gpg-key"
export KEY_COMMENT="gpg key"

gpg --batch --full-generate-key <<EOF
%no-protection
Key-Type: 1
Key-Length: 4096
Subkey-Type: 1
Subkey-Length: 4096
Expire-Date: 0
Name-Comment: ${KEY_COMMENT}
Name-Real: ${KEY_NAME}
EOF
```

2- Export the key pairs fingerprint in the shell
```bash
gpg --list-secret-keys "${KEY_NAME}"

sec   rsa4096 2020-09-06 [SC]
      710DC0DB6C1662F707095FC30233CB21E656A3CB
      
export KEY_FP="710DC0DB6C1662F707095FC30233CB21E656A3CB"
```

3- Export the generated private key to a kubernetes secret `sops-gpg-private-key` which will be used by flux's kustomize-controller to decrypt the secrets using sops.

```bash
gpg --export-secret-keys --armor "${KEY_FP}" | kubectl create secret generic sops-gpg-private-key --namespace=flux-system --from-file=sops.asc=/dev/stdin
```

4- Export the generated public key to a kubernetes secret `sops-gpg-public-key` which will be used by Weave GitOps Enterprise to encrypt the secrets created from the UI.

```bash
gpg --export --armor "${KEY_FP}" | kubectl create secret generic sops-gpg-public-key --namespace=flux-system --from-file=sops.asc=/dev/stdin
```

> It's recommended to remove the secret from your machine

```bash
gpg --delete-secret-keys "${KEY_FP}"
```

5- Create a kustomization for reconciling the secrets on the cluster and set the `--decryption-secret` flag to the name of the private key created in step 3.

```bash
flux create kustomization gpg-secrets \
--source=secrets \
--path=./secrets/gpg \
--prune=true \
--interval=10m \
--decryption-provider=sops \
--decryption-secret=sops-gpg-private-key
```

6- Annotate the kustomization object created in the previous step with the name and namespace of the public key created in step 4.

```bash
kubectl annotate kustomization gpg-secrets sops-public-key/name=sops-gpg-public-key sops-public-key/namespace=flux-system
```

The kustomization object should looks like this

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: gpg-secrets
  namespace: flux-system
  annotations:
    sops-public-key/name: sops-gpg-public-key
    sops-public-key/namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: secrets
  path: ./secrets/gpg
  decryption:
    provider: sops
    secretRef:
      name: sops-gpg-private-key
  prune: true
  validation: server
```

## Encrypting secrets using age

[age](https://github.com/FiloSottile/age) is a simple, modern and secure file encryption tool, It can be used to encrypt secrets using Weave GitOps Enterprise.

Here are the steps to generate an age key and configure your cluster to work with Weave GitOps Enterprise secrets management.

1- Generate an age key with age-keygen

```bash
age-keygen -o age.agekey

Public key: <public key>
```

2- Export the generated private key to a kubernetes secret `sops-age-private-key` which will be used by flux's kustomize-controller to decrypt the secrets using sops.

```bash
cat age.agekey | kubectl create secret generic sops-age-private-key --namespace=flux-system --from-file=age.agekey=/dev/stdin
```

4- Export the generated public key to a kubernetes secret `sops-age-public-key` which will be used by Weave GitOps Enterprise to encrypt the secrets created from the UI.

```bash
echo "<public key>" | kubectl create secret generic sops-age-public-key --namespace=flux-system --from-file=age.agekey=/dev/stdin
```

> It's recommended to remove the secret from your machine

```bash
rm -f age.ageKey
```

5- Create a kustomization for reconciling the secrets on the cluster and set the `--decryption-secret` flag to the name of the private key created in step 2

```bash
flux create kustomization age-secrets \
--source=secrets \ # the git source to reconcile the secrets from
--path=./secrets/age \
--prune=true \
--interval=10m \
--decryption-provider=sops \
--decryption-secret=sops-age-private-key
```

6- Annotate the kustomization object created in the previous step with the name and namespace of the public key created in step 4.

```bash
kubectl annotate kustomization secrets sops-public-key/name=sops-age-public-key sops-public-key/namespace=flux-system
```

The kustomization object should looks like this

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
kind: Kustomization
metadata:
  name: age-secrets
  namespace: flux-system
  annotations:
    sops-public-key/name: sops-age-public-key
    sops-public-key/namespace: flux-system
spec:
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: secrets
  path: ./secrets/age
  decryption:
    provider: sops
    secretRef:
      name: sops-age-private-key
  prune: true
  validation: server
```

> In case of using OpenPGP and age in the same cluster, you need to make the kustomizations point to different directories. This is because flux's kustomize-controller expects that all the secrets in the kustomization's path are encrypted with the same key.


## Security Recommendations
