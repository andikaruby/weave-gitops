---
title: Setup Secrets Operator
hide_title: true
---

import TierLabel from "../_components/TierLabel";
import CodeBlock from "@theme/CodeBlock";
import BrowserOnly from "@docusaurus/BrowserOnly";

# Setup Secrets Operator

Platform operators face a lot of challenges in bootstrapping and managing secrets in Kubernetes across multiple clusters. 
Specially when storing Kubernetes Secrets in `Git` safely and securely.
To achieve this, WGE has two approaches to work with kubernetes secrets: 
[External Secrets Operator](https://external-secrets.io/v0.8.1/) and [Mozilla SOPS](https://fluxcd.io/flux/guides/mozilla-sops/)

## Set up ESO

ESO can be installed using this [profile](https://github.com/weaveworks/weave-gitops-profile-examples/tree/main/charts/external-secrets) which is packaged with the [weaveworks-charts](https://github.com/weaveworks/weave-gitops-profile-examples) on any new or existing cluster.

### Prerequisites

- ESO [profile](https://github.com/weaveworks/weave-gitops-profile-examples/tree/main/charts/external-secrets) (Packed with `weaveworks-charts`)
- Secrets for the Profile Helm Repository, the Secrets Repository and the Secret Store. Follow this [guide](/secrets/bootstraping-secrets.mdx) for bootstraping secrets on leaf clusters

### Installation Steps

#### Install ESO on management cluster

To install the ESO profile on an exisitng cluster, use `Add an application` from the `Applications` page and select `external-secrets` from `weaveworks-charts`. Check the Profile values section for more info about configuring the values.yaml.

#### Install ESO on leaf cluster

To bootstrap the ESO profile on a leaf cluster, select `external-secrets` from the profiles dropdown in the `Create Cluster` page. Check the Profile values section for more info about configuring the values.yaml.

#### Profile values

You should then configure the `values.yaml` with the following values:

```yaml
external-secrets:
  installCRDs: true

secretStores:
  enabled: true
  url: ssh://git@github.com/<owner>/<repo-name>   # url for the git repository that contains the SecretStores
  tag: v1.0.0                                     # if you would like to download your secrets from specific tag
  # branch: main                                  # if you would like to download your secrets from specific branch
  path: .                                         # could be a path to the secrets dir or a kustomization.yaml file for the SecretStore in the GitRepository
  secretRef: ssh-creds                            # Name of the K8s secret with private repo auth credentials (private key, pub key, known hosts)
  # sourceRef:                                    # Could specify a name for an existing GitSource reference instead of creating a new one
  #   kind: GitRepository
  #   name: external-secrets
  #   namespace: external-secrets
```

## Set up SOPS

Weave GitOps Enterprise now supports managing secrets using SOPS, a tool that encrypts and decrypts secrets using various key management services.

### Install SOPS on management cluster

To install SOPS on management cluster. follow this [guide](https://fluxcd.io/flux/guides/mozilla-sops/) from flux documentation.

#### Using SOPS via WGE UI

To make use of the UI features, apply the previous [guide](https://fluxcd.io/flux/guides/mozilla-sops/) to generate the SOPS keys and the following steps:

- Create a kustomization for reconciling the secrets on the cluster and set the `--decryption-secret` flag to the name of the private key.

    ```yaml
    flux create kustomization gpg-secrets \
        --source=secrets \
        --path=./secrets/gpg \ # Path for the secrets on the git repository
        --prune=true \
        --interval=10m \
        --decryption-provider=sops \
        --decryption-secret=sops-gpg-private-key    # Private key secret name on the cluster
    ```

- Annotate the kustomization object created in the previous step with the name and namespace of the public key.

    ```yaml
    kubectl annotate kustomization gpg-secrets \
        sops-public-key/name=sops-gpg-public-key \ # Public key secret name on the cluster
        sops-public-key/namespace=flux-system      # Public key secret namespace on the cluster
    ```

- The kustomization object should looks like this

    ```yaml
    apiVersion: kustomize.toolkit.fluxcd.io/v1beta2
    kind: Kustomization
    metadata:
    name: gpg-secrets
    namespace: flux-system
    annotations:
        sops-public-key/name: sops-gpg-public-key
        sops-public-key/namespace: flux-system
    spec:
    interval: 10m
    sourceRef:
        kind: GitRepository
        name: secrets
    path: ./secrets/gpg
    decryption:
        provider: sops
        secretRef:
        name: sops-gpg-private-key
    prune: true
    validation: server
    ```

import SopsBootstrapJob from "!!raw-loader!./assets/sops-bootstrap-job.yaml";
import TemplateParams from "!!raw-loader!./assets/template-params.yaml";
import TemplateAnnotations from "!!raw-loader!./assets/template-annotations.yaml";

### Bootstrapping SOPS to leaf clusters

Bootstrapping SOPS to leaf clusters in WGE can be done by utilizing ClusterBootstrapConfig job to bootstrap Flux and SOPS.
The job is a container which generates SOPS secrets key pairs, Creates secrets with the private key, Creates a secret with the public key (to be used in self-serve flow) and the proper Rbac for it.
As well as an option to push the public key to the git repository via PR (to be distributed)

### Prerequisites

#### ClusterBootstrapConfig job

The following example is using GPG encryption to install SOPS and generate keys when bootstrapping leaf clusters. Create the following ClusterBootstrapConfig CR and push it to your fleet repo.
        
<details><summary>Expand to view </summary>
    <CodeBlock
    title="clusters/management/capi/boostrap/sops-bootstrap-job.yaml"
    className="language-yaml"
    >
        {SopsBootstrapJob}
    </CodeBlock>
</details>

#### Cluster template updates

In order to bootstrap SOPS to leaf clusters, we need some modifications to the cluster template to allow creating a [Kustomization](https://fluxcd.io/flux/guides/mozilla-sops/#configure-in-cluster-secrets-decryption)
for reconciling the secrets on the cluster using SOPS and to run the `ClusterBootstrapConfig` job during cluster creation.

- The template metadata should have annotation `templates.weave.works/sops-enabled: "true"`. This will be used by WGE to create the Kustomization with the cluster files.
- The template should have the following parameters that are needed for the Kustomization

    <details><summary>Expand to view </summary>
        <CodeBlock
        title="clusters/management/capi/templates/template.yaml"
        className="language-yaml"
        >
        {TemplateParams}
        </CodeBlock>
    </details>

- The template should have the following annotations under `GitOpsCluster` to be used in the bootstrap job

    <details><summary>Expand to view </summary>
        <CodeBlock
        title="clusters/management/capi/templates/template.yaml"
        className="language-yaml"
        >
        {TemplateAnnotations}
        </CodeBlock>
    </details>

### Installation Steps

To bootstrap the SOPS on a leaf cluster, Add a new cluster using the SOPS template from the Create Cluster page.

### What to expect 

- A leaf cluster created with Flux & SOPS bootstrapped
- A secret created on leaf cluster `sops-gpg` to decrypt secrets
- A secret created on leaf cluster `sops-gpg-pub` to encrypt secrets
- A Kustomization with `decryption` defined in it to `SOPS` location in the cluster repo location
- Added Role for the public key to be accessed through management cluster
- A PR is created to the cluster repo with the public key and SOPS creation rules (optional)
- Visit the Secrets Page and start using the UI secrets features
