---
title: Setup Secrets Operator
hide_title: true
---

# Setup Secrets Operator

Platform operators face a lot of challenges in bootstrapping and managing secrets in Kubernetes across multiple clusters. 
Specially when storing Kubernetes Secrets in `Git` safely and securely.
To achive this WGE is having to approches to work with kubernetes secrets.

1- [External Secrets Operator](https://external-secrets.io/v0.8.1/)
2- [Mozilla Sops](https://fluxcd.io/flux/guides/mozilla-sops/)

## Set up ESO

WGE installs ESO as a [profile](https://github.com/weaveworks/profiles-catalog/tree/main/charts/external-secrets)

The profile consists of 2 components

1- [The HelmChart for External Secrets Operator](https://github.com/weaveworks/profiles-catalog/blob/main/charts/external-secrets/Chart.yaml)
    - This will install the operator helm chart and the operator CRDs. more info [here](https://external-secrets.io/v0.8.1/examples/gitops-using-fluxcd/)

2- [Kustomization Reference to secret stores CRs](https://github.com/weaveworks/profiles-catalog/blob/main/charts/external-secrets/templates/secret-stores-kustomization.yaml)
    This kustomization refers to the git repository with the secrets and can have the values from [values file](https://github.com/weaveworks/profiles-catalog/blob/main/charts/external-secrets/values.yaml) according to your secrets git repository

### Installation Steps

- [Bootstrap the required secrets](/secrets/bootstraping-secrets.mdx) for the Profile Helm Repository and the Secrets Repository
- Install the [Profile Helm repository](https://docs.gitops.weave.works/docs/gitops-templates/cli/#profiles)
- To install the operator on Management Cluster
    - Go to `Applications` from the side bar and `Add new application`
    - Select `External Secrets` and input your `namespace`
        ![ESO Profile](./imgs/eso1.jpg)
    - Then Adjust the `values` according to your secrets git repository
        ![ESO Values](./imgs/eso2.jpg)
    - After that Authenticate with Github, Create and merge the pull request
        ![ESO PR](./imgs/eso3.jpg)
    - Once Flux reconcile the git source this should take few minutes, you will find the operator installed and the secrets lives in the cluster
- To bootstrap the operator on a leaf Cluster
    - Go to `Clusters` from the side bar and `Create A Cluster`
    - Select your template (must have the enable profiles annotation)
        ![ESO Cluster](./imgs/eso5.jpg)
    - Select `External Secrets` from and input your `namespace`
        ![ESO Profile](./imgs/eso4.jpg)
    - Then Adjust the `values` according to your secrets git repository
        ![ESO Values](./imgs/eso2.jpg)
    - After that Authenticate with Github, Create and merge the pull request
        ![ESO PR](./imgs/eso3.jpg)
    - Once the cluster is created and Flux reconcile the git source this should take few minutes, you will find the operator installed and the secrets lives in the cluster


## Set up SOPS

- Installing Sops on Managmenet cluster, follow [this guide](/secrets/setup-sops.mdx)

### Bootstrapping Sops to leaf clusters

- **This will need the following**
    - `ClusterBootstrapConfig` job to install sops and generate keys
        We will need a job to run in the bootstrapping of leaf cluster to install sops and generate the keys,the following example is using GPG encryption
        
        - The Job CR, follow [this guide](/cluster-management/getting-started/#add-a-cluster-bootstrap-config) for more information on ClusterBootstrapConfig

            <details><summary>Expand to view </summary>
            ```yaml
                apiVersion: capi.weave.works/v1alpha1
                kind: ClusterBootstrapConfig
                metadata:
                name: flux-installation
                namespace: default
                spec:
                clusterSelector:
                    matchLabels:
                    weave.works/flux: "bootstrap"
                jobTemplate:
                    generateName: "run-gitops-flux-{{ .ObjectMeta.Name }}"
                    spec:
                    initContainers:
                        - image: ghcr.io/fluxcd/flux-cli:v0.35.0
                        imagePullPolicy: Always
                        name: flux-bootstrap
                        resources: {}
                        volumeMounts:
                            - name: kubeconfig
                            mountPath: "/etc/gitops"
                            readOnly: true
                        args:
                            [
                            "bootstrap",
                            "github",
                            "--kubeconfig=/etc/gitops/value",
                            "--owner=<github-user>", # to be changed
                            "--repository=<github-repository>", # to be changed
                            "--path=./clusters/{{ .ObjectMeta.Namespace }}/{{ .ObjectMeta.Name }}",
                            ]
                        envFrom:
                            - secretRef:
                                name: my-pat # github token secret for flux: see https://docs.gitops.weave.works/docs/cluster-management/getting-started/
                        env:
                            - name: EXP_CLUSTER_RESOURCE_SET
                            value: "true"
                    containers:
                        - image: <image>:<tag> # build docker image
                        imagePullPolicy: Always
                        name: sops-bootstrap
                        resources: {}
                        volumeMounts:
                            - name: kubeconfig
                            mountPath: "/etc/gitops"
                            readOnly: true
                        command: ["bash", "/root/entrypoint.sh"]
                        envFrom:
                            - secretRef:
                                name: my-pat # github token secret for flux: see https://docs.gitops.weave.works/docs/cluster-management/getting-started/
                        env:
                            - name: KEY_NAME  
                            value: '{{ annotation "weave.works/sops-key-name" }}'
                            - name: KEY_COMMENT  
                            value: '{{ annotation "weave.works/sops-key-comment" }}'
                            - name: SOPS_SECRET_REF 
                            value: '{{ annotation "weave.works/sops-secret-ref" }}'
                            - name: SOPS_SECRET_REF_NAMESPACE
                            value: '{{ annotation "weave.works/sops-secret-ref-namespace" }}'
                            - name: PUSH_TO_GIT
                            value: '{{ annotation "weave.works/sops-push-to-git" }}'
                            - name: CLUSTER_NAME
                            value: "{{ .ObjectMeta.Name }}"
                            - name: CLUSTER_NAMESPACE
                            value: "{{ .ObjectMeta.Namespace }}"
                    restartPolicy: Never
                    volumes:
                        - name: kubeconfig
                        secret:
                            secretName: "{{ .ObjectMeta.Name }}-kubeconfig"
            ```

            </details>

        - Template Updates

            In order to install sops we need some modifications to the template to allow it to create a [Kustomization](https://fluxcd.io/flux/guides/mozilla-sops/#configure-in-cluster-secrets-decryption) for reconciling the secrets on the cluster for sops during cluster creation for the secrets path and run the `ClusterBootstrapConfig` job

            It will refer to `sops` location in the root of cluster files

            - Template Updates
                - It should have annotation `templates.weave.works/sops-enabled: "true"` to enable WGE to create the kustomization in cluster creation
                - It should have the following values thatâ€™s needed for **kustomization**

                - GitOps template with sops enabled (check how to add the annotations below)

                    <details><summary>Expand to view </summary>
                    ```yaml
                        - name: SOPS_KUSTOMIZATION_NAME
                        required: true
                        description: Define sops kustomization name - default directory in sops in cluster root path. (my-secrets)
                        - name: SOPS_SECRET_REF
                        required: true
                        description: Define sops secret reference name - should be added to cluster bootstrap job aswell. (sops-gpg)
                        - name: SOPS_SECRET_REF_NAMESPACE
                        required: true
                        description: Define sops secret reference namespace - should be added to cluster bootstrap job aswell. (flux-system)
                        - name: SOPS_PUSH_TO_GIT
                        required: true
                        description: Define if you want to push the public key to the git repo, expected values (true, false)
                        - name: SOPS_KEY_NAME
                        required: true
                        description: sops key name used to generate keys (test.yourdomain.com)
                        - name: SOPS_KEY_COMMENT
                        required: true
                        description: sops key comment used to generate keys (sops secret comment)
                    ```        
                    </details>

                - It should have the following annotations under `GitOpsCluster` to be used in the bootstrap job

                    <details><summary>Expand to view </summary>
                    ```yaml
                        # annotation to hold the kustomization values for cluster bootstrap job
                        weave.works/sops-kustomization: "${SOPS_KUSTOMIZATION_NAME}"
                        weave.works/sops-secret-ref: "${SOPS_SECRET_REF}"
                        weave.works/sops-secret-ref-namespace: "${SOPS_SECRET_REF_NAMESPACE}"
                        weave.works/sops-push-to-git: "${SOPS_PUSH_TO_GIT}"
                        weave.works/sops-key-name: "${SOPS_KEY_NAME}"
                        weave.works/sops-key-comment: "${SOPS_KEY_COMMENT}"
                    ```
                    </details>

- **Installation Steps**
    - Go to `Clusters` from the side bar and `Create A Cluster`
    - Select your Sops template (must have the annotation and parameters)
        ![ESO Cluster](./imgs/sops1.jpg)
    - Fill the data, Create and Merge the PR
    - You should expect the following after the cluster is ready
      - A leaf cluster created with flux & sops bootstrapped
      - A secret created on leaf cluster `sops-gpg` to decrypt secrets
      - A secret created on leaf cluster `sops-gpg-pub` to encrypt secrets
      - A Kustomization with `decryption` defined in it to `sops` location in the cluster repo location
      - A PR is created to the cluster repo with the public key and sops creation rules (optional)
      - Added Role for the public key to be accessed through management cluster
