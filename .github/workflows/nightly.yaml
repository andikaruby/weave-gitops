on:
  schedule:
    - cron: '0 0 * * Mon-Sat'
    - cron: '0 0 * * Sun'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: weaveworks/wego-app
  USE_NIGHTLY_BUILD_TAG: "true"

name: Nightly
jobs:
  build:
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-latest, macOS-latest]
    steps:
    - name: Install Go
      uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
      with:
        go-version: 1.20.x
    - name: Checkout code
      uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac # v4.0.0
    - name: Clean
      run: make clean
    - name: build
      run: make all BINARY_NAME=gitops-${{matrix.os}}-nightly
    - name: Store gitops binaries
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 # v3.1.3
      with:
          name: gitops-binaries-${{matrix.os}}-nightly
          path: bin
          retention-days: 1

  publish:
    if: success()
    needs: [test-eks, test-gke]
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [ubuntu-latest, macOS-latest]
    steps:
    - name: Download tested gitops binaries
      uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # v3.0.2
      with:
        name: gitops-binaries-${{matrix.os}}-nightly
        path: bin
    - name: Get current date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
    - name: publish nightly binaries to s3
      uses: aws-actions/configure-aws-credentials@8c3f20df09ac63af7b3ae3d7c91f105f857d8497 # v4.0.0
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2
    - run: |
        aws s3 cp bin/gitops-${{matrix.os}}-nightly s3://weave-gitops/nightly/${{ steps.date.outputs.date }}/gitops-${{matrix.os}}
